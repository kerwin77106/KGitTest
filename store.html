<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大樹KERWIN車行 - 店家專用</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        /* 自定義樣式 (第一個網頁原有的) */
        body {
            display: flex;
            /* 使用 Flexbox 佈局 */
            min-height: 100vh;
            /* 讓內容至少佔據整個視窗高度 */
        }

        #sidebar {
            width: 250px;
            /* 固定側邊欄寬度 */
            min-width: 250px;
            /* 最小寬度 */
            background-color: #343a40;
            /* 深色背景 */
            color: white;
            /* 白色文字 */
            padding-top: 20px;
            flex-shrink: 0;
            /* 不壓縮側邊欄 */
        }

        #sidebar .nav-link {
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            /* 圓角 */
            margin-bottom: 5px;
        }

        #sidebar .nav-link:hover {
            background-color: #007bff;
            /* 懸停時的藍色背景 */
            color: white;
        }

        #main-content {
            flex-grow: 1;
            /* 主內容區塊佔據剩餘空間 */
            padding: 20px;
            background-color: #f8f9fa;
            /* 淺灰色背景 */
        }

        .navbar-brand {
            font-size: 1.8rem;
            /* 標題字體大小 */
            font-weight: bold;
            color: #007bff !important;
            /* 標題顏色 */
        }

        .content-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            /* 輕微陰影 */
        }

        /* 從第二個網頁 (新增訂單表單) 複製過來的 CSS 規則 */
        #main-content h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        /* 針對新增訂單的 h2 標題 */
        .form-container {
            margin: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input[type="text"],
        .form-group input[type="tel"],
        .form-group input[type="datetime-local"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .form-group .checkbox-group label {
            font-weight: normal;
            margin-right: 10px;
        }

        .form-group .checkbox-group input[type="checkbox"] {
            margin-right: 5px;
        }

        .form-container button[type="button"] {
            /* 特定於 .form-container 內的按鈕 */
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .form-container button[type="button"]:hover {
            background-color: #0056b3;
        }

        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .success-message {
            color: green;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>

<body>

    <nav id="sidebar" class="d-flex flex-column">
        <h3 class="text-center mb-4">大樹KERWIN車行</h3>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#dashboard">儀表板</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#addOrder">新增訂單</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#queryOrder">查詢訂單</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#addDriver">新增司機</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#queryDriver">查詢司機</a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-danger" href="#">登出</a>
            </li>
        </ul>
    </nav>

    <div id="main-content">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">店家管理系統</a>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <span class="navbar-text me-3">
                                歡迎，店家！
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div id="content-display" class="content-section">
            <h4>歡迎使用店家管理系統！</h4>
            <p>請從左側選單選擇一個功能。</p>
            <p>這個區塊將會根據您在左側選單的選擇，顯示對應的功能內容（例如：新增訂單表單、查詢結果等）。</p>
        </div>
    </div>

    <div class="modal fade" id="assignDriverModal" tabindex="-1" aria-labelledby="assignDriverModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignDriverModalLabel">指派司機</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>正在為訂單 <strong id="assignOrderDisplayId"></strong> 指派司機。</p>
                    <input type="hidden" id="assignOrderIdHidden">
                    <div id="currentDriverInfoInModal" class="mb-2" style="display: none; font-size: 0.9em;">
                        <strong>目前指派:</strong> <span id="assignedDriverNameInModal"></span> (ID: <span
                            id="assignedDriverIdInModal"></span>)
                    </div>
                    <div class="mb-3">
                        <label for="driverSelect" class="form-label">選擇司機：</label>
                        <select class="form-select" id="driverSelect" aria-label="選擇司機">
                            <option selected value="">正在載入司機列表...</option>
                        </select>
                    </div>
                    <div id="assignDriverError" class="text-danger mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitDriverAssignment()">確認指派</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8000'; // 全域 API 基本 URL

        let assignDriverModalInstance = null; // 用於保存 Bootstrap Modal 實例

        // 初始化 Modal 實例 (可以在 DOMContentLoaded 中執行一次)
        document.addEventListener('DOMContentLoaded', function () {
            const assignDriverModalElement = document.getElementById('assignDriverModal');
            if (assignDriverModalElement) {
                assignDriverModalInstance = new bootstrap.Modal(assignDriverModalElement);
            }
        });

        async function openAssignDriverModal(orderId, currentDriverId) {
            if (!assignDriverModalInstance) {
                console.error("Assign Driver Modal 實例未初始化。");
                alert("指派司機介面錯誤，請重試。");
                return;
            }

            document.getElementById('assignOrderDisplayId').textContent = `#${orderId}`;
            document.getElementById('assignOrderIdHidden').value = orderId;
            const driverSelect = document.getElementById('driverSelect');
            const assignDriverError = document.getElementById('assignDriverError');

            const currentDriverInfoDiv = document.getElementById('currentDriverInfoInModal');
            const assignedDriverNameSpan = document.getElementById('assignedDriverNameInModal');
            const assignedDriverIdSpan = document.getElementById('assignedDriverIdInModal');

            assignDriverError.textContent = ''; // 清除之前的錯誤訊息
            driverSelect.innerHTML = '<option selected value="">正在載入司機列表...</option>'; // 重設下拉選單
            if (currentDriverInfoDiv) currentDriverInfoDiv.style.display = 'none';


            try {
                const response = await fetch(`${API_BASE_URL}/api/1/drivers`);
                if (!response.ok) {
                    throw new Error(`無法獲取司機列表: ${response.status}`);
                }
                const drivers = await response.json();

                // <<< 修改：加入 "取消指派" 選項，並調整預設選項 >>>
                driverSelect.innerHTML = ''; // 先清空

                const cancelOption = document.createElement('option');
                cancelOption.value = "0"; // 或者其他您系統中代表“未指派”的特定非空值，例如 -1
                cancelOption.textContent = "-- 取消指派 --";
                driverSelect.appendChild(cancelOption);
                // <<< 修改結束 >>>

                let currentAssignedDriverName = null;

                if (drivers && drivers.length > 0) {
                    drivers.forEach(driver => {
                        const option = document.createElement('option');
                        option.value = driver.driver_id;
                        option.textContent = `${escapeHtml(driver.name)} (ID: ${driver.driver_id}) - ${driver.license_plate || '車牌未知'}`;

                        if (currentDriverId && parseInt(driver.driver_id) === currentDriverId) {
                            option.selected = true; // 預選當前司機
                            currentAssignedDriverName = driver.name;
                        }
                        driverSelect.appendChild(option);
                    });
                } else {
                    // 如果沒有其他司機，至少保留 "取消指派" 選項
                    if (driverSelect.options.length === 1 && driverSelect.options[0].value === "0") {
                        // 可以選擇禁用 "取消指派" 如果沒有其他司機且也沒有當前指派的司機
                        // 但通常保留它以便總是能取消
                    }
                }

                // 如果 currentDriverId 是 0 或 null (表示未指派)，則預選 "取消指派"
                if (!currentDriverId || currentDriverId === 0) {
                    cancelOption.selected = true;
                }


                // ... (填充 currentDriverInfoInModal 的邏輯 - 保持不變) ...
                if (currentDriverId && currentDriverId !== 0 && currentAssignedDriverName && currentDriverInfoDiv && assignedDriverNameSpan && assignedDriverIdSpan) {
                    assignedDriverNameSpan.textContent = escapeHtml(currentAssignedDriverName);
                    assignedDriverIdSpan.textContent = escapeHtml(String(currentDriverId));
                    currentDriverInfoDiv.style.display = 'block'; // 顯示區塊
                } else if (currentDriverInfoDiv) { // 如果沒有 currentDriverId，確保區塊是隱藏的
                    currentDriverInfoDiv.style.display = 'none';
                }

                assignDriverModalInstance.show(); // 顯示 Modal
            } catch (error) {
                console.error("打開指派司機 Modal 時出錯:", error);
                assignDriverError.textContent = `錯誤: ${error.message}`;
                // 即使出錯也嘗試顯示 Modal，讓使用者看到錯誤訊息
                assignDriverModalInstance.show();
                driverSelect.innerHTML = '<option value="">無法載入司機</option>';
            }
        }

        async function submitDriverAssignment() {
            const orderId = document.getElementById('assignOrderIdHidden').value;
            const driverSelect = document.getElementById('driverSelect');
            const driverId = driverSelect.value;
            const assignDriverError = document.getElementById('assignDriverError');
            assignDriverError.textContent = ''; // 清除錯誤

            if (!driverId) {
                assignDriverError.textContent = '請選擇一位司機。';
                return;
            }

            const payload = {
                order_id: parseInt(orderId),
                driver_id: parseInt(driverId) // 後端 AssignDriverHandler 預期是數字
            };

            console.log("準備指派司機，Payload:", payload);

            try {
                const response = await fetch(`${API_BASE_URL}/api/order/assign-driver`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                const result = await response.json(); // 嘗試解析 JSON 回應

                if (response.ok) {
                    alert(result.message || '司機指派成功！');
                    if (assignDriverModalInstance) {
                        assignDriverModalInstance.hide();
                    }
                    // 更新前端列表：您可以選擇重新載入整個訂單列表，或只更新該行的司機狀態
                    // 簡單起見，先重新載入當前激活的 Tab 的訂單
                    const activeTabButton = document.querySelector('#queryOrderTabs .nav-link.active');
                    if (activeTabButton) {
                        activeTabButton.click(); // 重新觸發當前 Tab 的點擊事件以刷新列表
                    } else {
                        // 如果找不到 active tab，可以嘗試刷新今日訂單
                        document.getElementById('today-orders-tab')?.click();
                    }
                } else {
                    throw new Error(result.error || `指派失敗: ${response.status}`);
                }
            } catch (error) {
                console.error("指派司機 API 請求失敗:", error);
                assignDriverError.textContent = `指派錯誤: ${error.message}`;
                alert(`指派錯誤: ${error.message}`);
            }
        }

        // --- 新增司機相關函式 ---
        async function submitNewDriver() {
            const nameInput = document.getElementById("driverNameInput");
            const phoneInput = document.getElementById("driverPhoneInput");
            const licensePlateInput = document.getElementById("driverLicensePlateInput");
            const vehicleBrandInput = document.getElementById("driverVehicleBrandInput");
            const notesInput = document.getElementById("driverNotesInput");
            const statusDiv = document.getElementById("addDriverStatus");

            if (statusDiv) statusDiv.innerHTML = '';

            const name = nameInput ? nameInput.value : '';
            const phone = phoneInput ? phoneInput.value : '';
            const license_plate = licensePlateInput ? licensePlateInput.value : '';
            const vehicle_brand = vehicleBrandInput ? vehicleBrandInput.value : '';
            const notes = notesInput ? notesInput.value : '';

            if (!name || !phone) {
                if (statusDiv) statusDiv.innerHTML = '<p class="text-danger">錯誤：司機姓名和電話為必填欄位！</p>';
                alert("司機姓名和電話為必填欄位！");
                return;
            }

            const payloadObject = {
                table: "crc.drivers", name: name, phone: phone,
                license_plate: license_plate, vehicle_brand: vehicle_brand, notes: notes
            };
            console.log("Frontend: Payload object for new driver:", payloadObject);
            const jsonBodyToSend = JSON.stringify(payloadObject);
            console.log("Frontend: JSON body for new driver:", jsonBodyToSend);

            if (statusDiv) statusDiv.innerHTML = '<p class="text-info">正在新增司機資料...</p>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/2/insert`, {
                    method: 'POST', mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: jsonBodyToSend, // 使用上面已經 stringify 過的 jsonBodyToSend
                });

                if (response.ok) {
                    if (statusDiv) statusDiv.innerHTML = '<p class="text-success">司機資料已成功新增！</p>';
                    alert("司機資料已成功新增！");
                    if (nameInput) nameInput.value = ''; if (phoneInput) phoneInput.value = '';
                    if (licensePlateInput) licensePlateInput.value = ''; if (vehicleBrandInput) vehicleBrandInput.value = '';
                    if (notesInput) notesInput.value = '';
                } else {
                    const errorText = await response.text();
                    console.error('新增司機失敗:', response.status, errorText);
                    if (statusDiv) statusDiv.innerHTML = `<p class="text-danger">新增司機失敗：${response.status} - ${escapeHtml(errorText) || '未知錯誤'}</p>`;
                    alert(`新增司機失敗：${response.status} - ${errorText || '未知錯誤'}`);
                }
            } catch (error) {
                console.error('提交新增司機請求時發生錯誤:', error);
                if (statusDiv) statusDiv.innerHTML = '<p class="text-danger">提交請求時發生錯誤，請檢查網路連線或聯絡管理員。</p>';
                alert("提交請求時發生錯誤，請檢查網路連線。");
            }
        }

        function escapeHtml(unsafe) {
            if (unsafe == null) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // --- 查詢司機相關函式 ---
        function initializeQueryDriverView() {
            console.log("Initializing Query Driver View");
            fetchDrivers();
        }

        async function fetchDrivers() {
            const driverResultsBody = document.getElementById('driverResultsBody');
            const loadingMessage = document.getElementById('driverLoadingMessage');
            const noResultsMessage = document.getElementById('noDriverResultsMessage');

            if (!driverResultsBody || !loadingMessage || !noResultsMessage) {
                console.error("查詢司機：缺少必要的 HTML 元素。");
                if (driverResultsBody) driverResultsBody.innerHTML = `<tr><td colspan="7" class="text-danger text-center">錯誤：頁面元件遺失。</td></tr>`;
                return;
            }

            driverResultsBody.innerHTML = `<tr><td colspan="7" class="text-center">正在載入司機資料...</td></tr>`;
            loadingMessage.style.display = 'block';
            noResultsMessage.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/api/1/drivers`);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('獲取司機資料失敗:', response.status, errorText);
                    driverResultsBody.innerHTML = `<tr><td colspan="7" class="text-danger text-center">無法載入司機資料：${response.status} ${errorText || ''}</td></tr>`;
                    return;
                }
                const drivers = await response.json();
                console.log('獲取的司機資料:', drivers);
                displayDrivers(drivers);
            } catch (error) {
                console.error('fetchDrivers 函式錯誤:', error);
                driverResultsBody.innerHTML = `<tr><td colspan="7" class="text-danger text-center">載入司機資料時發生錯誤。</td></tr>`;
                noResultsMessage.textContent = '載入司機資料時發生錯誤。';
                noResultsMessage.className = 'alert alert-danger';
                noResultsMessage.style.display = 'block';
            } finally {
                if (loadingMessage) loadingMessage.style.display = 'none';
            }
        }

        function displayDrivers(drivers) {
            const driverResultsBody = document.getElementById('driverResultsBody');
            const noResultsMessage = document.getElementById('noDriverResultsMessage');

            noResultsMessage.className = 'alert alert-info';
            noResultsMessage.textContent = '目前沒有司機資料。';

            if (!driverResultsBody) {
                console.error("displayDrivers: driverResultsBody not found");
                if (noResultsMessage) {
                    noResultsMessage.textContent = '錯誤：頁面表格元件遺失，無法顯示司機資料。';
                    noResultsMessage.className = 'alert alert-danger text-center';
                    noResultsMessage.style.display = 'block';
                }
                return;
            }

            driverResultsBody.innerHTML = '';

            if (!drivers || drivers.length === 0) {
                if (noResultsMessage) noResultsMessage.style.display = 'block';
                const row = driverResultsBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 7; // <<< colspan 保持為 7 (ID, 名字, 電話, 車牌, 廠牌, 備註, 操作)
                cell.textContent = '目前沒有活動中的司機資料。'; // 修改提示訊息
                cell.className = 'text-center text-muted';
                return;
            }
            if (noResultsMessage) noResultsMessage.style.display = 'none';

            drivers.forEach(driver => {
                const row = driverResultsBody.insertRow();
                row.insertCell().textContent = driver.driver_id || 'N/A';
                row.insertCell().textContent = driver.name || 'N/A';
                row.insertCell().textContent = driver.phone || 'N/A';
                row.insertCell().textContent = driver.license_plate || 'N/A';
                row.insertCell().textContent = driver.vehicle_brand || 'N/A';
                row.insertCell().textContent = driver.notes || '';

                // 操作按鈕
                const actionsCell = row.insertCell();
                actionsCell.classList.add('text-nowrap');

                // 修改資料按鈕
                const modifyButton = document.createElement('button');
                modifyButton.className = 'btn btn-sm btn-warning me-1';
                modifyButton.innerHTML = '<i class="bi bi-pencil-square"></i> 修改';
                modifyButton.title = '修改司機資料';
                // 假設 driver 物件中沒有 driver_status 了，或者即使有也是 0
                modifyButton.onclick = () => openEditDriverView(driver.driver_id, driver);
                actionsCell.appendChild(modifyButton);

                // 刪除 (軟刪除) 按鈕
                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-sm btn-danger';
                deleteButton.innerHTML = '<i class="bi bi-trash"></i> 刪除';
                deleteButton.title = '刪除此司機 (設為不活動)';
                // 因為列表只顯示活動司機，所以這個按鈕總是 "刪除"
                deleteButton.onclick = () => confirmSoftDeleteDriver(driver.driver_id, driver.name);
                actionsCell.appendChild(deleteButton);
            });
        }

        function confirmSoftDeleteDriver(driverId, driverName) {
            if (confirm(`您確定要刪除 (停用) 司機 "${escapeHtml(driverName)}" (ID: ${driverId}) 嗎？\n此操作會將司機狀態設為不活動 (-1)。`)) {
                softDeleteDriver(driverId, -1); // 傳遞 -1 作為新的狀態
            }
        }

        async function softDeleteDriver(driverId, newStatus) { // newStatus 可以是 -1 (停用) 或 0 (啟用)
            const actionText = (newStatus === -1) ? "停用" : "啟用";
            // 可選：在按鈕旁顯示小小的 loading 狀態
            // alert(`正在 ${actionText} 司機 ID: ${driverId}...`);

            const payload = {
                driver_id: driverId,
                status: newStatus
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/driver/update-status`, {
                    method: 'PUT', // 與後端 UpdateDriverStatusHandler 的設定一致
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                const result = await response.json(); // 嘗試解析 JSON 回應

                if (response.ok) {
                    alert(result.message || `司機已成功 ${actionText}！`);
                    fetchDrivers(); // 重新載入司機列表以更新顯示 (因為我們現在只顯示活動司機)
                } else {
                    throw new Error(result.error || `${actionText} 司機失敗: ${response.status}`);
                }
            } catch (err) {
                console.error(`${actionText} 司機時發生錯誤:`, err);
                alert(`${actionText} 司機時發生錯誤: ${err.message}`);
            }
        }

        async function saveDriverChanges(driverId) { // driverId 可以從按鈕點擊時傳入
            const updateStatusDiv = document.getElementById('driverUpdateStatusDiv'); // 假設有這個 div 顯示訊息
            if (updateStatusDiv) {
                updateStatusDiv.innerHTML = '<div class="alert alert-info py-2">正在儲存司機資料...</div>';
            }

            // 1. 從表單收集更新後的資料
            const name = document.getElementById('editDriverNameInput').value.trim();
            const phone = document.getElementById('editDriverPhoneInput').value.trim();
            const licensePlate = document.getElementById('editDriverLicensePlateInput').value.trim();
            const vehicleBrand = document.getElementById('editDriverVehicleBrandInput').value.trim();
            const notes = document.getElementById('editDriverNotesInput').value.trim();

            // 2. 前端基本驗證
            if (!name || !phone) {
                const errorMsg = "錯誤：司機姓名和電話為必填欄位！";
                if (updateStatusDiv) updateStatusDiv.innerHTML = `<div class="alert alert-danger py-2">${escapeHtml(errorMsg)}</div>`;
                alert(errorMsg);
                return;
            }
            if (driverId === null || driverId === undefined || isNaN(parseInt(driverId))) {
                const errorMsg = "錯誤：無效的司機 ID。";
                if (updateStatusDiv) updateStatusDiv.innerHTML = `<div class="alert alert-danger py-2">${escapeHtml(errorMsg)}</div>`;
                alert(errorMsg);
                return;
            }


            // 3. 建立 JSON payload
            // 欄位名稱需與後端 UpdateDriverDetailsHandler 解析時使用的 key 一致
            const payload = {
                driver_id: parseInt(driverId), // 後端期望的是整數
                name: name,
                phone: phone,
                license_plate: licensePlate,
                vehicle_brand: vehicleBrand,
                notes: notes
            };

            console.log("準備更新司機資料，Payload:", JSON.stringify(payload));

            // 4. 呼叫後端更新 API
            try {
                const response = await fetch(`${API_BASE_URL}/api/driver/update-details`, {
                    method: 'PUT', // 與後端 UpdateDriverDetailsHandler 中設定的 method 一致
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                let result;
                const responseText = await response.text();
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.error("更新司機 API 回應不是有效的 JSON:", responseText);
                    if (!response.ok) {
                        throw new Error(`伺服器錯誤 ${response.status}: ${responseText || response.statusText}`);
                    }
                    result = { error: "無法解析伺服器回應，但請求可能已成功。回應內容: " + responseText };
                }

                if (response.ok) {
                    const successMsg = result.message || '司機資料修改成功！';
                    if (updateStatusDiv) updateStatusDiv.innerHTML = `<div class="alert alert-success py-2">${escapeHtml(successMsg)}</div>`;
                    alert(escapeHtml(successMsg));

                    // 修改成功後，返回司機列表並刷新
                    goBackToQueryDriver(); // 這個函式會點擊「查詢司機」的導覽連結
                } else {
                    throw new Error(result.error || `更新司機資料失敗: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error("更新司機 API 請求失敗:", error);
                const errorMsg = `更新錯誤: ${error.message}`;
                if (updateStatusDiv) updateStatusDiv.innerHTML = `<div class="alert alert-danger py-2">${escapeHtml(errorMsg)}</div>`;
                alert(escapeHtml(errorMsg));
            }
        }

        // 為了讓 saveDriverChanges 被正確呼叫，您也需要 openEditDriverView 函式來產生表單和按鈕
        // 以下是一個非常基礎的 openEditDriverView 範例，您需要根據您的需求填充它
        function openEditDriverView(driverId, driverData) {
            const contentDisplay = document.getElementById('content-display');
            if (!contentDisplay) {
                console.error("content-display element not found for edit driver form");
                return;
            }

            // driverData 應該是包含該司機所有資訊的物件，例如從 displayDrivers 傳過來的
            // { driver_id, name, phone, license_plate, vehicle_brand, notes, driver_status }
            const currentName = driverData ? escapeHtml(driverData.name || '') : '';
            const currentPhone = driverData ? escapeHtml(driverData.phone || '') : '';
            const currentLicensePlate = driverData ? escapeHtml(driverData.license_plate || '') : '';
            const currentVehicleBrand = driverData ? escapeHtml(driverData.vehicle_brand || '') : '';
            const currentNotes = driverData ? escapeHtml(driverData.notes || '') : '';

            const formHtml = `
        <div class="content-section">
            <h4>修改司機資料 - ID: ${driverId}</h4>
            <hr>
            <div class="form-container" style="max-width: 600px;">
                <div class="mb-3">
                    <label for="editDriverNameInput" class="form-label">司機姓名：</label>
                    <input type="text" class="form-control" id="editDriverNameInput" value="${currentName}" required>
                </div>
                <div class="mb-3">
                    <label for="editDriverPhoneInput" class="form-label">電話：</label>
                    <input type="text" class="form-control" id="editDriverPhoneInput" value="${currentPhone}" required>
                </div>
                <div class="mb-3">
                    <label for="editDriverLicensePlateInput" class="form-label">車牌號碼：</label>
                    <input type="text" class="form-control" id="editDriverLicensePlateInput" value="${currentLicensePlate}">
                </div>
                <div class="mb-3">
                    <label for="editDriverVehicleBrandInput" class="form-label">車輛廠牌：</label>
                    <input type="text" class="form-control" id="editDriverVehicleBrandInput" value="${currentVehicleBrand}">
                </div>
                <div class="mb-3">
                    <label for="editDriverNotesInput" class="form-label">備註：</label>
                    <textarea class="form-control" id="editDriverNotesInput" rows="3">${currentNotes}</textarea>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-secondary me-2" onclick="goBackToQueryDriver()">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveDriverChanges(${driverId})">儲存修改</button>
                </div>
                <div id="driverUpdateStatusDiv" class="mt-3"></div>
            </div>
        </div>
    `;
            contentDisplay.innerHTML = formHtml;
        }

        // 輔助函式，用於返回查詢司機列表 (如果還沒有，可以這樣寫)
        function goBackToQueryDriver() {
            const queryDriverLink = document.querySelector('a.nav-link[href="#queryDriver"]');
            if (queryDriverLink && typeof queryDriverLink.click === 'function') {
                queryDriverLink.click();
            } else {
                console.error("無法找到 #queryDriver 連結。");
                // Fallback: Reload the page to the hash if click doesn't work
                // window.location.hash = '#queryDriver';
                // window.location.reload();
            }
        }

        async function viewOrderDetails(orderId) { // orderId 應該是您訂單的純數字 ID
            const contentDisplay = document.getElementById('content-display');
            if (!contentDisplay) {
                console.error("嚴重錯誤: 找不到 content-display 元素。");
                alert("頁面結構錯誤，無法顯示訂單詳情。");
                return;
            }

            // 顯示載入狀態
            contentDisplay.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Loading...</span></div><h4 class="mt-2">正在載入訂單 #${orderId} 的詳細資料...</h4></div>`;

            try {
                // 確保 API 端點與您 Server.java 中設定的一致
                const response = await fetch(`${API_BASE_URL}/api/order/details/${orderId}`);
                if (!response.ok) {
                    let errorMsg = `HTTP 錯誤 ${response.status}`;
                    try {
                        const errorResult = await response.json();
                        errorMsg = errorResult.message || errorMsg;
                    } catch (e) {
                        // 如果回應不是 JSON 或解析失敗，使用 response.statusText
                        errorMsg = response.statusText || errorMsg;
                    }
                    throw new Error(`無法獲取訂單詳情: ${errorMsg}`);
                }
                const orderData = await response.json();
                if (Object.keys(orderData).length === 0) { // 檢查是否為空物件
                    throw new Error(`找不到訂單 #${orderId} 的資料，或回傳資料為空。`);
                }
                renderOrderDetails(orderData); // 呼叫新的函式來顯示資料
            } catch (error) {
                console.error('獲取訂單詳情失敗:', error);
                contentDisplay.innerHTML = `<div class="alert alert-danger">無法載入訂單詳情：${error.message} <br><button class="btn btn-secondary btn-sm mt-2" onclick="goBackToQueryOrder()">返回查詢列表</button></div>`;
            }
        }

        async function renderOrderDetails(data) {
            const contentDisplay = document.getElementById('content-display');

            // 將後端傳來的時間格式 (YYYY-MM-DD HH:MM:SS) 轉換為 datetime-local 需要的格式 (YYYY-MM-DDTHH:MM)
            let scheduledTimeForInput = '';
            if (data.scheduled_pickup_time && data.scheduled_pickup_time !== 'N/A') {
                try {
                    const dateStr = data.scheduled_pickup_time.includes('T')
                        ? data.scheduled_pickup_time.substring(0, 16) // 如果是 YYYY-MM-DDTHH:MM:SSZ 或類似格式
                        : data.scheduled_pickup_time.replace(' ', 'T').substring(0, 16); // 將 YYYY-MM-DD HH:MM:SS -> YYYY-MM-DDTHH:MM
                    // 驗證一下格式是否大致正確 (YYYY-MM-DDTHH:MM)
                    if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(dateStr)) {
                        scheduledTimeForInput = dateStr;
                    } else {
                        console.warn("scheduled_pickup_time 格式不符 datetime-local:", data.scheduled_pickup_time);
                        // 嘗試從 Date 物件轉換，如果原始格式是標準的
                        const d = new Date(data.scheduled_pickup_time.replace(' ', 'T'));
                        if (!isNaN(d.getTime())) {
                            const year = d.getFullYear();
                            const month = (d.getMonth() + 1).toString().padStart(2, '0');
                            const day = d.getDate().toString().padStart(2, '0');
                            const hours = d.getHours().toString().padStart(2, '0');
                            const minutes = d.getMinutes().toString().padStart(2, '0');
                            scheduledTimeForInput = `${year}-${month}-${day}T${hours}:${minutes}`;
                        }
                    }
                } catch (e) {
                    console.error("格式化 scheduled_pickup_time 錯誤:", e);
                }
            }

            // 為了下拉選單，我們需要非同步獲取車型和加購項目列表
            // 這裡先定義 HTML 結構，稍後用 JavaScript 填充下拉選單並選中

            const detailsHtml = `
        <div id="orderDetailsEditView" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">修改訂單資料 - #${escapeHtml(String(data.order_id))}</h4>
                <div>
                    <button class="btn btn-danger me-2" onclick="confirmCancelOrder(${data.order_id})">取消訂單</button>
                    <button class="btn btn-success me-2" onclick="saveOrderChanges(${data.order_id}, ${data.customer_id})">儲存修改</button>
                    <button class="btn btn-outline-secondary" onclick="goBackToQueryOrder()">取消返回</button>
                </div>
            </div>
            <hr class="mt-0">
            <form id="editOrderForm">
                <div class="row mb-3">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <div class="card">
                            <div class="card-header"><h5>顧客資訊 (手動修改)</h5></div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <label for="editCustomerName" class="form-label-sm">姓名：</label>
                                    <input type="text" class="form-control form-control-sm" id="editCustomerName" value="${escapeHtml(data.customer_name || '')}">
                                </div>
                                <div class="mb-2">
                                    <label for="editCustomerPhone" class="form-label-sm">電話：</label>
                                    <input type="text" class="form-control form-control-sm" id="editCustomerPhone" value="${escapeHtml(data.customer_phone || '')}">
                                </div>
                                <div class="mb-0">
                                    <label for="editCustomerAddress" class="form-label-sm">地址：</label>
                                    <input type="text" class="form-control form-control-sm" id="editCustomerAddress" value="${escapeHtml(data.address || '')}">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><h5>服務資訊 (下拉式修改)</h5></div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <label for="editServiceType" class="form-label-sm">服務類型：</label>
                                    <select class="form-select form-select-sm" id="editServiceType">
                                        <option value="接機" ${data.service_type === '接機' ? 'selected' : ''}>接機</option>
                                        <option value="送機" ${data.service_type === '送機' ? 'selected' : ''}>送機</option>
                                        <option value="其他" ${data.service_type !== '接機' && data.service_type !== '送機' && data.service_type ? 'selected' : ''}>${escapeHtml(data.service_type)}</option> 
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label for="editScheduledTime" class="form-label-sm">預定時間：</label>
                                    <input type="datetime-local" class="form-control form-control-sm" id="editScheduledTime" value="${scheduledTimeForInput}">
                                </div>
                                <div class="mb-2">
                                    <label for="editAirport" class="form-label-sm">機場：</label>
                                    <select class="form-select form-select-sm" id="editAirport"></select>
                                </div>
                                <div class="mb-0">
                                    <label for="editTerminal" class="form-label-sm">航廈：</label>
                                    <select class="form-select form-select-sm" id="editTerminal">
                                        <option value="">請先選擇機場</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6 mb-3 mb-md-0">
                         <div class="card">
                            <div class="card-header"><h5>車輛與項目 (下拉式修改/勾選)</h5></div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <label for="editCarModel" class="form-label-sm">車型：</label>
                                    <select class="form-select form-select-sm" id="editCarModel">
                                        <option value="">載入中...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label-sm">加購項目：</label>
                                    <div id="editAddonsContainer" class="border p-2 rounded" style="max-height: 150px; overflow-y: auto;">
                                        <small class="text-muted">載入中...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><h5>金額 (手動修改) 與狀態 (不可改)</h5></div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <label for="editTotalAmount" class="form-label-sm">總金額：</label>
                                    <input type="number" class="form-control form-control-sm" id="editTotalAmount" value="${data.total_amount || 0}" step="1">
                                </div>
                                <p class="mb-0"><strong>訂單狀態：</strong> ${escapeHtml(data.order_status)}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header"><h5>司機資訊 (不可改)</h5></div>
                    <div class="card-body">
                        ${data.driver_name && data.driver_name !== '未指派' ? `
                            <p class="mb-1"><strong>司機姓名：</strong> ${escapeHtml(data.driver_name)}</p>
                            <p class="mb-1"><strong>司機電話：</strong> ${escapeHtml(data.driver_phone || 'N/A')}</p>
                            <p class="mb-1"><strong>車牌號碼：</strong> ${escapeHtml(data.driver_license_plate || 'N/A')}</p>
                            <p class="mb-0"><strong>車輛廠牌：</strong> ${escapeHtml(data.driver_vehicle_brand || 'N/A')}</p>
                        ` : `<p class="mb-0"><strong>司機：</strong> <span class="text-muted">未指派</span></p>`
                }
                    </div>
                </div>
                <div id="updateOrderStatus" class="mt-3"></div>
            </form>
        </div>
    `;
            contentDisplay.innerHTML = detailsHtml;

            // HTML 結構插入後，開始填充下拉選單並預選
            // **注意**: data.airport 和 data.terminal 是名稱，我們需要將它們與 populateAirports/Terminals 中的 value 匹配
            // **注意**: data.car_product_id_selected 和 data.addon_product_ids_selected 是 ID，用於預選

            // 填充機場和航廈 (類似 initializeAddOrderForm 中的邏輯)
            const editAirportSelect = document.getElementById('editAirport');
            const editTerminalSelect = document.getElementById('editTerminal');

            // 填充機場
            if (editAirportSelect) {
                editAirportSelect.innerHTML = '<option value="">請選擇機場...</option>';
                API_AIRPORTS.forEach(airport => { // API_AIRPORTS 是您之前定義的全域變數
                    const option = document.createElement('option');
                    option.value = airport.name; // 使用機場名稱作為 value，以便和 data.airport 匹配預選
                    option.textContent = airport.name;
                    if (data.airport === airport.name) {
                        option.selected = true;
                    }
                    editAirportSelect.appendChild(option);
                });
                // 機場選擇後觸發填充航廈
                editAirportSelect.addEventListener('change', function () {
                    populateEditTerminals(this.value, editTerminalSelect, null); // 傳入 null 作為預選航廈
                });
                // 初始載入時，如果機場已選，則填充航廈並預選
                if (data.airport) {
                    populateEditTerminals(data.airport, editTerminalSelect, data.terminal);
                }
            }

            // 填充車型下拉選單
            const editCarModelSelect = document.getElementById('editCarModel');
            if (editCarModelSelect) {
                populateEditCarTypes(editCarModelSelect, data.car_product_id_selected);
            }

            // 填充加購項目核取方塊
            const editAddonsContainer = document.getElementById('editAddonsContainer');
            if (editAddonsContainer) {
                populateEditAddons(editAddonsContainer, data.addon_product_ids_selected || []); // 確保是陣列
            }
        }

        // 輔助函式：填充修改用的航廈下拉選單
        function populateEditTerminals(selectedAirportName, terminalSelectElement, selectedTerminalNameValue) { // 參數改回 NameValue
            if (!terminalSelectElement) {
                console.error("populateEditTerminals: terminalSelectElement is null");
                return;
            }
            terminalSelectElement.innerHTML = '<option value="">請選擇航廈...</option>';
            let terminalsToShow = [];

            const airportData = API_AIRPORTS.find(a => a.name === selectedAirportName);

            if (airportData && API_TERMINALS[airportData.id]) {
                terminalsToShow = API_TERMINALS[airportData.id];
            } else if (selectedAirportName) {
                terminalSelectElement.innerHTML = '<option value="">該機場無可用航廈資料</option>';
            } else {
                terminalSelectElement.innerHTML = '<option value="">請先選擇機場</option>';
            }

            terminalsToShow.forEach(terminal => {
                const option = document.createElement('option');
                option.value = terminal.name; // <<< 修改：option 的 value 使用 terminal.name (例如 "第一航廈")
                option.textContent = terminal.name; // option 顯示的文字是 terminal.name

                // 進行預選比較時，直接比較名稱
                if (selectedTerminalNameValue !== null && selectedTerminalNameValue !== undefined &&
                    selectedTerminalNameValue === terminal.name) { // <<< 修改：直接比較名稱字串
                    option.selected = true;
                }
                terminalSelectElement.appendChild(option);
            });
        }

        // 輔助函式：填充修改用的車型下拉選單
        async function populateEditCarTypes(selectElement, selectedCarProductId) {
            selectElement.innerHTML = '<option value="">載入中...</option>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/1/products/cars`);
                if (!response.ok) throw new Error('無法載入車型');
                const carTypes = await response.json();
                selectElement.innerHTML = '<option value="">請選擇車型...</option>';
                carTypes.forEach(car => {
                    const option = document.createElement('option');
                    option.value = car.product_id; // value 是 ID
                    option.textContent = car.Product_name;
                    if (selectedCarProductId && parseInt(car.product_id) === parseInt(selectedCarProductId)) {
                        option.selected = true;
                    }
                    selectElement.appendChild(option);
                });
            } catch (error) {
                console.error(error);
                selectElement.innerHTML = `<option value="">${error.message}</option>`;
            }
        }

        // 輔助函式：填充修改用的加購項目核取方塊
        async function populateEditAddons(containerElement, selectedAddonProductIds) {
            containerElement.innerHTML = '<small class="text-muted">載入中...</small>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/1/products/addons`);
                if (!response.ok) throw new Error('無法載入加購項目');
                const addonData = await response.json();
                containerElement.innerHTML = ''; // 清空載入中訊息
                if (Array.isArray(addonData) && addonData.length > 0) {
                    addonData.forEach(addon => {
                        const div = document.createElement('div');
                        div.className = 'form-check form-check-sm';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'form-check-input';
                        checkbox.value = addon.product_id; // value 是 ID
                        checkbox.id = 'edit-addon-' + addon.product_id;
                        if (selectedAddonProductIds.includes(parseInt(addon.product_id))) {
                            checkbox.checked = true;
                        }
                        const label = document.createElement('label');
                        label.className = 'form-check-label';
                        label.htmlFor = 'edit-addon-' + addon.product_id;
                        label.textContent = addon.Product_name;

                        div.appendChild(checkbox);
                        div.appendChild(label);
                        containerElement.appendChild(div);
                    });
                } else {
                    containerElement.innerHTML = '<small class="text-muted">目前無加購項目。</small>';
                }
            } catch (error) {
                console.error(error);
                containerElement.innerHTML = `<small class="text-danger">${error.message}</small>`;
            }
        }


        // 新增：儲存訂單修改的函式
        async function saveOrderChanges(orderId, customerId) {
            const updateStatusDiv = document.getElementById('updateOrderStatus');
            if (updateStatusDiv) {
                updateStatusDiv.innerHTML = '<div class="alert alert-info py-2">正在儲存修改...</div>';
            }

            // 1. 收集所有表單數據
            const customerName = document.getElementById('editCustomerName').value.trim();
            const customerPhone = document.getElementById('editCustomerPhone').value.trim();
            const customerAddress = document.getElementById('editCustomerAddress').value.trim(); // 這是 pickup_address
            const serviceType = document.getElementById('editServiceType').value;
            let scheduledPickupTime = document.getElementById('editScheduledTime').value; // 格式 YYYY-MM-DDTHH:MM
            const airport = document.getElementById('editAirport').value; // 機場名稱
            const terminal = document.getElementById('editTerminal').value; // 航廈名稱
            const carProductIdStr = document.getElementById('editCarModel').value;
            const totalAmountStr = document.getElementById('editTotalAmount').value;

            // 2. 收集選中的加購項目 ID 並組合成 "&" 分隔的字串
            const addonIdArray = [];
            const selectedAddonsCheckboxes = document.querySelectorAll('#editAddonsContainer input[type="checkbox"]:checked');
            selectedAddonsCheckboxes.forEach(checkbox => {
                addonIdArray.push(checkbox.value); // checkbox 的 value 應該是 product_id
            });
            const addonProductIdsString = addonIdArray.join('&'); // 例如 "202&203" 或 ""

            // 3. 前端基本驗證 (您可以根據需要做得更詳細)
            if (!customerName || !customerPhone || !customerAddress || !scheduledPickupTime || !carProductIdStr || !totalAmountStr) {
                const errorMsg = "錯誤：顧客姓名、電話、地址、預定時間、車型和總金額為必填項！";
                if (updateStatusDiv) updateStatusDiv.innerHTML = `<div class="alert alert-danger py-2">${errorMsg}</div>`;
                alert(errorMsg);
                return;
            }

            let carProductId;
            try {
                carProductId = parseInt(carProductIdStr);
                if (isNaN(carProductId) || carProductId <= 0) throw new Error();
            } catch (e) {
                const errorMsg = "錯誤：車型選擇無效。";
                if (updateStatusDiv) updateStatusDiv.innerHTML = `<div class="alert alert-danger py-2">${errorMsg}</div>`;
                alert(errorMsg);
                return;
            }

            let totalAmount;
            try {
                totalAmount = parseFloat(totalAmountStr);
                if (isNaN(totalAmount) || totalAmount < 0) throw new Error(); // 金額可以為0，但不應為負
            } catch (e) {
                const errorMsg = "錯誤：總金額格式無效。";
                if (updateStatusDiv) updateStatusDiv.innerHTML = `<div class="alert alert-danger py-2">${errorMsg}</div>`;
                alert(errorMsg);
                return;
            }

            // 確保 scheduled_pickup_time 格式為 YYYY-MM-DDTHH:MM:SS (如果後端嚴格要求)
            // datetime-local input 的 value (payload.scheduled_pickup_time) 通常是 "YYYY-MM-DDTHH:MM"
            if (scheduledPickupTime && scheduledPickupTime.length === 16) { // YYYY-MM-DDTHH:MM
                scheduledPickupTime += ":00"; // 補上秒，變成 YYYY-MM-DDTHH:MM:SS
            }


            // 4. 建立 JSON payload
            // 欄位名稱需與後端 UpdateOrderHandler 解析時使用的 key 一致
            // (如果後端用 DBConnect02.parseJson，它會移除引號，所以大小寫和底線風格要一致)
            const payload = {
                order_id: orderId,
                customer_id: customerId,
                customer_name: customerName,
                customer_phone: customerPhone,
                customer_address: customerAddress,
                service_type: serviceType,
                scheduled_pickup_time: scheduledPickupTime,
                airport: airport,
                terminal: terminal,
                car_product_id: carProductId,
                total_amount: totalAmount,
                addon_product_ids: addonProductIdsString // <<< 現在是 & 分隔的字串
            };

            console.log("準備更新訂單，Payload:", JSON.stringify(payload)); // 印出準備發送的 JSON 字串

            // 5. 呼叫後端更新 API
            try {
                const response = await fetch(`${API_BASE_URL}/api/order/update`, {
                    method: 'PUT', // 或 'POST'，與您後端 UpdateOrderHandler 的設定一致
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                // 嘗試解析 JSON 回應，即使回應不是 2xx 也可能包含錯誤訊息
                let result;
                const responseText = await response.text(); // 先獲取文字，避免 response.json() 對空回應或非JSON回應拋錯
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    // 如果回應不是有效的 JSON，將整個 text 作為錯誤訊息的一部分
                    console.error("API 回應不是有效的 JSON:", responseText);
                    if (!response.ok) { // 如果 HTTP 狀態碼表示錯誤
                        throw new Error(`伺服器錯誤 ${response.status}: ${responseText || response.statusText}`);
                    }
                    // 如果 HTTP 狀態OK但JSON解析失敗，這比較奇怪，但仍報錯
                    result = { error: "無法解析伺服器回應，但請求可能已成功。回應內容: " + responseText };
                }


                if (response.ok) {
                    const successMsg = result.message || '訂單修改成功！';
                    if (updateStatusDiv) updateStatusDiv.innerHTML = `<div class="alert alert-success py-2">${escapeHtml(successMsg)}</div>`;
                    alert(escapeHtml(successMsg));
                    // 修改成功後，通常會返回列表頁或重新載入唯讀的詳情頁
                    // 這裡我們直接呼叫返回查詢列表的函式
                    goBackToQueryOrder();
                } else {
                    // 如果 result.error 存在，使用它，否則使用 response.statusText
                    throw new Error(result.error || `更新失敗: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error("更新訂單 API 請求失敗:", error);
                const errorMsg = `更新錯誤: ${error.message}`;
                if (updateStatusDiv) updateStatusDiv.innerHTML = `<div class="alert alert-danger py-2">${escapeHtml(errorMsg)}</div>`;
                alert(escapeHtml(errorMsg));
            }
        }
        // 3. **新增** goBackToQueryOrder 函式
        function goBackToQueryOrder() {
            // 模擬點擊「查詢訂單」導覽連結以重新載入該視圖
            const queryOrderLink = document.querySelector('a.nav-link[href="#queryOrder"]');
            if (queryOrderLink && typeof queryOrderLink.click === 'function') {
                // 觸發點擊前，確保查詢訂單的 tab 內容是初始狀態或被清空
                // (這取決於您的 initializeQueryOrderView 如何處理重新進入)
                // 或者，更簡單的方式是讓 click 事件本身去觸發內容的重新渲染
                queryOrderLink.click();
            } else {
                console.error("無法找到 #queryOrder 連結或其 click 方法無效。");
                alert("無法返回列表，請手動點擊左側選單。");
                // 作為備用，直接重新載入頁面到查詢訂單的 hash
                // window.location.hash = '#queryOrder';
                // window.location.reload(); // 強制重載可能會丟失一些狀態，但能確保重新初始化
            }
        }

        function confirmCancelOrder(orderId) {
            if (confirm(`您是否確定要取消訂單 #${orderId}？\n此操作將無法復原。`)) {
                executeCancelOrder(orderId);
            }
        }

        async function executeCancelOrder(orderId) {
            const updateStatusDiv = document.getElementById('updateOrderStatus'); // 用於顯示訊息的 div
            if (updateStatusDiv) {
                updateStatusDiv.innerHTML = '<div class="alert alert-info py-2">正在取消訂單...</div>';
            } else {
                console.warn("未找到 updateOrderStatus div，取消進度訊息將不會顯示。");
            }

            const payload = {
                order_id: orderId, // 後端 UpdateOrderStatusHandler 會 parseInt
                status: "已取消"    // 新的狀態
            };

            console.log("準備取消訂單，Payload:", JSON.stringify(payload));

            try {
                const response = await fetch(`${API_BASE_URL}/api/order/update-status`, {
                    method: 'PUT', // 與後端 UpdateOrderStatusHandler 設定的 method 一致
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                let result;
                const responseText = await response.text();
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.error("取消訂單 API 回應不是有效的 JSON:", responseText);
                    if (!response.ok) {
                        throw new Error(`伺服器錯誤 ${response.status}: ${responseText || response.statusText}`);
                    }
                    result = { error: "無法解析伺服器回應，但請求可能已成功。回應內容: " + responseText };
                }

                if (response.ok) {
                    const successMsg = result.message || '訂單已成功取消！';
                    if (updateStatusDiv) updateStatusDiv.innerHTML = `<div class="alert alert-success py-2">${escapeHtml(successMsg)}</div>`;
                    alert(escapeHtml(successMsg));

                    // 取消成功後，返回訂單列表並刷新
                    goBackToQueryOrder();
                } else {
                    throw new Error(result.error || `取消訂單失敗: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error("取消訂單 API 請求失敗:", error);
                const errorMsg = `取消訂單錯誤: ${error.message}`;
                if (updateStatusDiv) updateStatusDiv.innerHTML = `<div class="alert alert-danger py-2">${escapeHtml(errorMsg)}</div>`;
                alert(escapeHtml(errorMsg));
            }
        }



        // --- 新增訂單表單相關 (從 add_order_form.html 整合) ---
        const API_AIRPORTS = [
            { id: "TPE", name: "桃園國際機場" }, { id: "TSA", name: "台北松山機場" }, { id: "KHH", name: "高雄小港機場" }
        ];
        const API_TERMINALS = {
            "TPE": [{ id: "1", name: "第一航廈" }, { id: "2", name: "第二航廈" }],
            "TSA": [{ id: "1", name: "第一航廈" }, { id: "2", name: "第二航廈" }],
            "KHH": [{ id: "D", name: "國內航廈" }, { id: "I", name: "國際航廈" }]
        };
        let airportSelect, terminalSelect, carTypeSelect, addonsContainer, submissionStatusDiv;

        async function populateSelectWithOptions(selectElement, apiUrl, valueField, textField, defaultOptionText = "請選擇...") {
            // console.log(`populateSelectWithOptions called for: ${selectElement ? selectElement.id : 'null_selectElement'}, URL: ${apiUrl}`);
            if (!selectElement) {
                console.error(`錯誤: populateSelectWithOptions 中的 selectElement (${selectElement ? selectElement.id : 'ID未知'}) 是 null!`);
                return;
            }
            selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
            try {
                const response = await fetch(apiUrl);
                // console.log(`Workspace response status for ${apiUrl}: ${response.status}`);
                if (!response.ok) {
                    console.error(`無法獲取資料從 ${apiUrl}: ${response.status} ${response.statusText}`);
                    selectElement.innerHTML = `<option value="">無法載入選項</option>`; return;
                }
                const data = await response.json();
                // console.log(`從 ${apiUrl} 獲取的原始資料:`, data);
                if (Array.isArray(data)) {
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item[valueField];
                        option.textContent = item[textField];
                        selectElement.appendChild(option);
                    });
                } else {
                    console.error(`從 ${apiUrl} 獲取的資料格式不正確，應為陣列。收到的資料:`, data);
                    selectElement.innerHTML = `<option value="">資料格式錯誤</option>`;
                }
            } catch (error) {
                console.error(`填充下拉選單 ${selectElement.id} 時發生錯誤:`, error);
                selectElement.innerHTML = `<option value="">載入時發生錯誤</option>`;
            }
            // console.log(`populateSelectWithOptions for ${selectElement.id} finished.`);
        }

        function populateAirports() { /* ... populateAirports 完整定義 ... */
            // console.log("populateAirports 函式開始執行。");
            if (!airportSelect) { console.error("錯誤：在 populateAirports 中 airportSelect 是 null！"); return; }
            airportSelect.innerHTML = `<option value="">請選擇機場...</option>`;
            API_AIRPORTS.forEach(airport => {
                const option = document.createElement('option');
                option.value = airport.name;
                option.textContent = airport.name;
                airportSelect.appendChild(option);
            });
            // console.log("populateAirports 函式執行完畢。");
        }

        function populateTerminals(selectedAirportName) { /* ... populateTerminals 完整定義 ... */
            // console.log("populateTerminals 函式開始執行，選擇的機場是:", selectedAirportName);
            if (!terminalSelect) { console.error("錯誤：在 populateTerminals 中 terminalSelect 是 null！"); return; }
            terminalSelect.innerHTML = `<option value="">請選擇航廈...</option>`;
            let terminalsToShow = [];
            const airportData = API_AIRPORTS.find(a => a.name === selectedAirportName);
            if (airportData && API_TERMINALS[airportData.id]) {
                terminalsToShow = API_TERMINALS[airportData.id];
            } else {
                terminalSelect.innerHTML = `<option value="">請先選擇有效機場</option>`;
            }
            terminalsToShow.forEach(terminal => {
                const option = document.createElement('option');
                option.value = terminal.name;
                option.textContent = terminal.name;
                terminalSelect.appendChild(option);
            });
            // console.log("populateTerminals 函式執行完畢。");
        }

        async function populateCarTypes() { /* ... populateCarTypes 完整定義 ... */
            // console.log("populateCarTypes 函式開始執行。");
            if (!carTypeSelect) { console.error("錯誤：在 populateCarTypes 中 carTypeSelect 是 null！"); return; }
            await populateSelectWithOptions(carTypeSelect, `${API_BASE_URL}/api/1/products/cars`, 'product_id', 'Product_name', '請選擇車輛類型...');
            // console.log("populateCarTypes 函式執行完畢。");
        }

        async function populateAddons() { /* ... populateAddons 完整定義 ... */
            // console.log("populateAddons 函式開始執行。");
            if (!addonsContainer) { console.error("錯誤：在 populateAddons 中 addonsContainer 是 null！"); if (document.getElementById('addonsContainer')) document.getElementById('addonsContainer').innerHTML = '<p>錯誤：找不到加購項目容器</p>'; return; }
            addonsContainer.innerHTML = '<p>正在載入加購項目...</p>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/1/products/addons`);
                if (!response.ok) { addonsContainer.innerHTML = '<p>無法載入加購項目</p>'; return; }
                const addonData = await response.json();
                addonsContainer.innerHTML = '';
                if (Array.isArray(addonData) && addonData.length > 0) {
                    addonData.forEach(addon => {
                        const checkboxLabel = document.createElement('label'); checkboxLabel.style.display = 'block';
                        const checkbox = document.createElement('input'); checkbox.type = 'checkbox';
                        checkbox.name = 'addons'; checkbox.value = addon.product_id; checkbox.id = 'addon-' + addon.product_id;
                        checkboxLabel.appendChild(checkbox); checkboxLabel.appendChild(document.createTextNode(" " + addon.Product_name));
                        addonsContainer.appendChild(checkboxLabel);
                    });
                } else if (Array.isArray(addonData) && addonData.length === 0) {
                    addonsContainer.textContent = '目前無加購項目。';
                } else { addonsContainer.textContent = '加購項目資料格式錯誤。'; }
            } catch (error) { addonsContainer.innerHTML = '<p>載入加購項目時發生錯誤</p>'; }
            // console.log("populateAddons 函式執行完畢。");
        }

        window.submitOrder = async function () { /* ... submitOrder 完整定義 ... */
            if (!submissionStatusDiv) { alert("提交狀態顯示區域未準備好，請重試。"); return; }
            submissionStatusDiv.textContent = ''; submissionStatusDiv.className = '';
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            // ... (獲取其他表單欄位值) ...
            const airport = document.getElementById('airport').value;
            const terminal = document.getElementById('terminal').value;
            const serviceTypeVal = document.getElementById('serviceType').value; // Renamed to avoid conflict
            const scheduledPickupTimeVal = document.getElementById('scheduledPickupTime').value; // Renamed
            const carTypeElement = document.getElementById('carType');
            const carProductId = carTypeElement ? carTypeElement.value : "";
            const totalAmountStr = document.getElementById('totalAmount').value;

            const selectedAddons = [];
            const addonCheckboxes = document.querySelectorAll('#addonsContainer input[name="addons"]:checked');
            let addonIdArray = [];
            addonCheckboxes.forEach(checkbox => {
                addonIdArray.push(checkbox.value); // 收集所有選中的 productId (字串形式)
            });
            const concatenated_ids_string = addonIdArray.join('&'); // 直接得到 "4&5&6&7" 或空字串 ""
            let selectedAddons_payload = []; // 如果沒有加購項目，就是空陣列
            if (addonIdArray.length > 0) {
                let concatenated_ids_string = addonIdArray.join('&'); // 用 '&' 串接所有 ID
                selectedAddons_payload = [{ "productId": concatenated_ids_string }]; // 放入一個物件中，再放入陣列
            }


            addonCheckboxes.forEach(checkbox => { selectedAddons.push({ productId: parseInt(checkbox.value) }); });

            if (!customerName || !customerPhone || !document.getElementById('customerAddress').value || !airport || !terminal || !serviceTypeVal || !scheduledPickupTimeVal || !carProductId || !totalAmountStr) {
                submissionStatusDiv.textContent = '錯誤：所有必填欄位都必須填寫！'; submissionStatusDiv.className = 'error-message'; return;
            }
            if (terminal === "請先選擇有效機場" || terminal === "") {
                submissionStatusDiv.textContent = '錯誤：請選擇有效的航廈！'; submissionStatusDiv.className = 'error-message'; return;
            }
            let totalAmount;
            try {
                totalAmount = parseFloat(totalAmountStr); if (isNaN(totalAmount) || totalAmount <= 0) { throw new Error("總金額必須是有效的正數。"); }
            } catch (error) { submissionStatusDiv.textContent = `錯誤：${error.message}`; submissionStatusDiv.className = 'error-message'; return; }

            const orderData = {
                customerName: customerName, // 確保這些 key 與後端 CreateOrderHandler 中 params.get("key") 的 key 一致
                customerPhone: customerPhone,
                customerAddress: document.getElementById('customerAddress').value,
                airport: document.getElementById('airport').value,
                terminal: document.getElementById('terminal').value, // 現在是航廈名稱
                serviceType: document.getElementById('serviceType').value,
                scheduledPickupTime: document.getElementById('scheduledPickupTime').value,
                carProductId: parseInt(carProductId), // carProductId 也是字串，後端會 parseInt
                addon_product_ids: concatenated_ids_string, // <<< 修改於此：直接使用字串，欄位名也修改
                totalAmount: totalAmount // totalAmount 也是字串，後端會 parseDouble
            };
            submissionStatusDiv.textContent = '正在提交訂單...'; submissionStatusDiv.className = '';
            try {
                const response = await fetch(`${API_BASE_URL}/api/orders/create`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData)
                });
                if (response.ok) {
                    const result = await response.json();
                    submissionStatusDiv.textContent = `訂單已成功新增！訂單 ID: ${result.orderId || '未知'}`;
                    submissionStatusDiv.className = 'success-message';
                } else {
                    const errorResult = await response.json().catch(() => ({ message: response.statusText || "未知錯誤" }));
                    submissionStatusDiv.textContent = `訂單提交失敗: ${errorResult.message}`;
                    submissionStatusDiv.className = 'error-message';
                }
            } catch (error) {
                submissionStatusDiv.textContent = '提交訂單時發生網路連線錯誤，請稍後再試。';
                submissionStatusDiv.className = 'error-message';
            }
        }

        function initializeAddOrderForm() { /* ... initializeAddOrderForm 完整定義，包含對 populate... 函式的呼叫以及 airportSelect 的 change 事件監聽器 ... */
            console.log("initializeAddOrderForm 函式開始執行！");
            airportSelect = document.getElementById('airport');
            terminalSelect = document.getElementById('terminal');
            carTypeSelect = document.getElementById('carType');
            addonsContainer = document.getElementById('addonsContainer');
            submissionStatusDiv = document.getElementById('submissionStatus');

            // 增加對 contentDisplay 的檢查，雖然理論上它應該在 DOMContentLoaded 之後總是存在
            const localContentDisplay = document.getElementById('content-display');

            if (!airportSelect || !terminalSelect || !carTypeSelect || !addonsContainer || !submissionStatusDiv) {
                console.error("錯誤：新增訂單表單中的一個或多個必要元素未找到！");
                // 在這裡的 contentDisplay 變數可能未定義，因為它是 DOMContentLoaded 裡的局部變數
                // 所以我們使用 localContentDisplay
                if (localContentDisplay) localContentDisplay.innerHTML += "<p class='error-message'>新增訂單表單初始化失敗，部分元件遺失。</p>";
                else console.error("content-display element not found for error message in initializeAddOrderForm");
                return;
            }
            populateAirports(); populateTerminals(airportSelect.value);
            populateCarTypes(); populateAddons();
            if (airportSelect) {
                airportSelect.addEventListener('change', function () { populateTerminals(this.value); });
            } else { console.error("錯誤：在 initializeAddOrderForm 中 airportSelect 未找到，無法綁定 change 事件！"); }
            console.log("initializeAddOrderForm 函式執行完畢。");
        }

        // --- 查詢訂單相關函式 ---
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // 月份是 0-indexed
            const day = String(date.getDate()).padStart(2, '0');
            // ↓↓↓ 請將您的 return 語句修改成下面這一行 ↓↓↓
            return `${year}-${month}-${day}`;
        }

        async function fetchOrders(params) { /* ... fetchOrders 完整定義 ... */
            const orderResultsBody = document.getElementById('orderResultsBody');
            const loadingMessage = document.getElementById('loadingMessage');
            const noResultsMessage = document.getElementById('noResultsMessage');

            if (!orderResultsBody || !loadingMessage || !noResultsMessage) {
                console.error("顯示訂單所需的元素缺失。");
                if (orderResultsBody) orderResultsBody.innerHTML = `<tr><td colspan="12" class="text-danger text-center">錯誤：頁面元件遺失。</td></tr>`;
                return;
            }
            orderResultsBody.innerHTML = ''; loadingMessage.style.display = 'block'; noResultsMessage.style.display = 'none';
            noResultsMessage.className = 'alert alert-info'; noResultsMessage.textContent = '找不到符合條件的訂單。';
            const queryParams = new URLSearchParams(params).toString();
            // console.log(`正在獲取訂單，參數: ${queryParams}`);
            // --- ↓↓↓ 除錯：印出將要 fetch 的完整 URL ↓↓↓ ---
            const fullUrl = `${API_BASE_URL}/api/1/view/orders?${queryParams}`;
            console.log("Fetching URL:", fullUrl);
            // --- ↑↑↑ 除錯結束 ↑↑↑ ---
            try {
                const response = await fetch(fullUrl);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `API請求失敗: ${response.status}` }));
                    orderResultsBody.innerHTML = `<tr><td colspan="12" class="text-danger text-center">無法載入訂單：${errorData.message}</td></tr>`;
                    return;
                }
                const orders = await response.json(); displayOrders(orders);
            } catch (error) {
                console.error('fetchOrders 錯誤:', error);
                orderResultsBody.innerHTML = `<tr><td colspan="12" class="text-danger text-center">載入訂單時發生錯誤。</td></tr>`;
                noResultsMessage.textContent = '載入訂單時發生網路或伺服器錯誤。';
                noResultsMessage.className = 'alert alert-danger'; noResultsMessage.style.display = 'block';
            } finally { loadingMessage.style.display = 'none'; }
        }

        function displayOrders(orders) {
            const orderResultsBody = document.getElementById('orderResultsBody');
            const noResultsMessage = document.getElementById('noResultsMessage');

            // 設定預設的無結果訊息樣式和內容
            noResultsMessage.className = 'alert alert-info text-center'; // 確保置中
            noResultsMessage.textContent = '找不到符合條件的訂單。';

            if (!orderResultsBody) {
                console.error("displayOrders: orderResultsBody not found");
                if (noResultsMessage) { // 如果 noResultsMessage 元素存在
                    noResultsMessage.textContent = '錯誤：頁面表格元件遺失，無法顯示訂單。';
                    noResultsMessage.className = 'alert alert-danger text-center';
                    noResultsMessage.style.display = 'block';
                }
                return;
            }

            orderResultsBody.innerHTML = ''; // 清空現有內容

            if (!orders || orders.length === 0) {
                if (noResultsMessage) noResultsMessage.style.display = 'block';
                // 如果沒有訂單，顯示一個提示訊息的行
                const row = orderResultsBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 13; // <<< 確保 colspan 與表頭欄位數一致
                cell.textContent = '目前沒有符合條件的訂單。';
                cell.className = 'text-center text-muted';
                return;
            }

            if (noResultsMessage) noResultsMessage.style.display = 'none'; // 如果有訂單，隱藏無結果訊息

            orders.forEach(order => {
                const row = orderResultsBody.insertRow();
                row.insertCell().textContent = order.display_order_id || 'N/A'; // 您的 VIEW 中此欄位名為 display_order_id
                row.insertCell().textContent = order.customer_name || 'N/A';
                row.insertCell().textContent = order.customer_phone || 'N/A';
                row.insertCell().textContent = order.display_address || 'N/A'; // 您的 VIEW 中此欄位名為 display_address
                row.insertCell().textContent = order.service_type || 'N/A';

                let formattedTime = 'N/A';
                if (order.scheduled_pickup_time) {
                    try {
                        // 假設 scheduled_pickup_time 是 YYYY-MM-DD HH:MM:SS 格式
                        const dateStr = order.scheduled_pickup_time.includes('T') ? order.scheduled_pickup_time : order.scheduled_pickup_time.replace(' ', 'T');
                        const dateObj = new Date(dateStr);
                        if (!isNaN(dateObj.getTime())) {
                            formattedTime = dateObj.toLocaleString('zh-TW', {
                                year: 'numeric', month: '2-digit', day: '2-digit',
                                hour: '2-digit', minute: '2-digit', hour12: false
                            });
                        } else {
                            formattedTime = order.scheduled_pickup_time; // 無法解析則顯示原始值
                        }
                    } catch (e) {
                        console.warn("日期格式化錯誤 for scheduled_pickup_time in displayOrders:", order.scheduled_pickup_time, e);
                        formattedTime = order.scheduled_pickup_time; // 出錯則顯示原始值
                    }
                }
                row.insertCell().textContent = formattedTime;

                row.insertCell().textContent = order.airport || 'N/A';
                row.insertCell().textContent = order.terminal || 'N/A';
                row.insertCell().textContent = order.car_model || 'N/A';

                let formattedAmount = 'N/A';
                if (order.display_amount != null) { // 您的 VIEW 中此欄位名為 display_amount
                    try {
                        // 格式化為台幣，無小數
                        formattedAmount = Number(order.display_amount).toLocaleString('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    } catch (e) {
                        formattedAmount = order.display_amount;
                    }
                }
                row.insertCell().textContent = formattedAmount;

                row.insertCell().textContent = order.order_status || 'N/A'; // 訂單狀態

                 const statusCell = row.insertCell(); // 獲取訂單狀態的儲存格 (<td>)
            const currentOrderStatus = order.order_status || 'N/A'; // 獲取當前訂單狀態文字
            statusCell.textContent = currentOrderStatus; // 先設定文字內容

            // 清除可能存在的舊樣式 (如果表格是動態更新而非完全重建)
            statusCell.className = ''; // 清除所有 class
            statusCell.style.color = '';  // 重設行內 style 顏色

            // 定義不同狀態群組，請確保這些字串與您資料庫中 `orders.order_status` 的實際值完全匹配
            const inProgressStatuses = ["司機已出發", "已抵達上車點", "乘客已上車"];
            const completedStatuses = ["行程已完成", "已完成"]; // "已完成" 可能是由店家手動設定的
            const cancelledStatuses = ["已取消", "訂單取消"];

            if (inProgressStatuses.includes(currentOrderStatus)) {
                statusCell.classList.add('text-primary'); // Bootstrap 的藍色
                // 或者，如果您不想用 Bootstrap class： statusCell.style.color = 'blue';
            } else if (completedStatuses.includes(currentOrderStatus)) {
                statusCell.classList.add('text-success'); // Bootstrap 的綠色
                // 或者： statusCell.style.color = 'green';
            } else if (cancelledStatuses.includes(currentOrderStatus)) {
                statusCell.classList.add('text-danger');  // Bootstrap 的紅色
                // 或者： statusCell.style.color = 'red';
            } else {
                // 其他狀態 (例如 "已確認", "已指派司機" 等被視為 "待處理")
                // 將使用預設的文字顏色，不需要特別設定
                // 如果您想給 "待處理" 一個特定顏色 (例如深灰色)，可以這樣加：
                // statusCell.classList.add('text-dark'); // Bootstrap 的深灰色
            }

                // 新增司機指派狀態欄位
                const driverStatusCell = row.insertCell();
                driverStatusCell.innerHTML = ''; // 清空儲存格，以便重建內容

                let assignmentStatusText = '';
                let isAssigned = false;

                // 您的 VIEW (v_order_display_summary) 現在應該有 order.driver_id 和 order.driver_name 欄位
                // order.driver_id 來自 orders.driver_id
                // order.driver_name 來自 drivers.name
                if (order.driver_id && String(order.driver_id).trim() !== '' && String(order.driver_id) !== '0' && String(order.driver_id).toLowerCase() !== 'null' &&
                    order.driver_name && String(order.driver_name).trim() !== '' && String(order.driver_name).toLowerCase() !== 'n/a') {
                    isAssigned = true;
                    // <<< 修改這裡：同時顯示司機名稱和 ID >>>
                    assignmentStatusText = `已指派: ${escapeHtml(order.driver_name)} (ID: ${escapeHtml(String(order.driver_id))})`;
                } else {
                    assignmentStatusText = '未指派';
                }

                const statusSpan = document.createElement('span');
                statusSpan.textContent = assignmentStatusText;
                statusSpan.className = isAssigned ? 'text-success fw-bold' : 'text-danger';
                statusSpan.style.display = 'inline-block'; // 讓 min-width 生效
                statusSpan.style.minWidth = '180px';      // 設定一個最小寬度，您可以根據實際情況調整此數值
                // 例如 '150px', '200px' 等，確保能容納最常見的較長文字
                statusSpan.style.marginRight = '8px';      // 保留與按鈕的間隔
                driverStatusCell.appendChild(statusSpan);

                // 指派/更改司機按鈕
                const assignButton = document.createElement('button');
                assignButton.className = 'btn btn-sm btn-outline-primary';
                assignButton.textContent = isAssigned ? '更改指派' : '指派司機';
                assignButton.title = '指派/更改司機';

                let currentDriverIdForModal = null;
                if (order.driver_id && String(order.driver_id).trim() !== '' && String(order.driver_id).toLowerCase() !== 'null') {
                    const parsedId = parseInt(String(order.driver_id));
                    if (!isNaN(parsedId) && parsedId > 0) {
                        currentDriverIdForModal = parsedId;
                    }
                }

                // 確保 order.display_order_id 是正確的訂單ID (通常是數字)
                const orderIdForModal = parseInt(String(order.display_order_id));

                assignButton.onclick = () => openAssignDriverModal(orderIdForModal, currentDriverIdForModal);
                driverStatusCell.appendChild(assignButton);

                // <<< 新增開始：「操作」欄位內容 (第13個資料欄) >>>
                const actionsCell = row.insertCell(); // 建立新的儲存格 (<td>)

                const viewButton = document.createElement('button');
                viewButton.className = 'btn btn-sm btn-info'; // 您可以選擇合適的按鈕樣式
                viewButton.textContent = '詳情';
                viewButton.title = '查看訂單詳情與修改';

                // 確保 order.display_order_id 是傳遞給 viewOrderDetails 的正確訂單 ID (通常是數字)
                // viewOrderDetails 函式您先前已經定義過
                const orderIdForDetails = parseInt(String(order.display_order_id));
                if (!isNaN(orderIdForDetails)) {
                    viewButton.onclick = () => viewOrderDetails(orderIdForDetails);
                } else {
                    console.error("無效的訂單ID，無法建立詳情按鈕:", order.display_order_id);
                    viewButton.disabled = true; // 如果ID無效，則禁用按鈕
                }
                actionsCell.appendChild(viewButton);
                // <<< 新增結束 >>>
            });
        }





        function initializeQueryOrderView() {
            console.log("正在初始化查詢訂單檢視 (含篩選器)...");

            // 1. 獲取所有必要的 HTML 元素
            const todayTab = document.getElementById('today-orders-tab');
            const tomorrowTab = document.getElementById('tomorrow-orders-tab');
            const customRangeTab = document.getElementById('custom-range-tab'); // <<< 新增：宣告 customRangeTab
            const searchCustomRangeBtn = document.getElementById('searchCustomRange');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            // const customRangeResultsPane = document.getElementById('customRangeResults'); // 如果您會用到它
            const filterRadios = document.querySelectorAll('input[name="orderStatusFilter"]');
            const orderResultsBody = document.getElementById('orderResultsBody'); // 用於清空提示

            // 2. 檢查重要元素是否存在
            if (!todayTab || !tomorrowTab || !customRangeTab || !searchCustomRangeBtn ||
                !startDateInput || !endDateInput || !filterRadios || filterRadios.length === 0 || !orderResultsBody) {
                console.error("查詢訂單檢視：一個或多個必要元素缺失。請檢查 HTML 結構和 ID。");
                const container = document.getElementById('orderResultsTableContainer');
                if (container) container.innerHTML = "<p class='text-danger'>查詢訂單介面初始化失敗，缺少必要元件。</p>";
                return;
            }

            // 3. 初始化日期變數
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            const todayStr = formatDate(today);       // 確保 formatDate 函式已定義
            const tomorrowStr = formatDate(tomorrow);

            // 設定自訂日期區間輸入框的預設值
            startDateInput.value = todayStr;
            endDateInput.value = todayStr;

            // 4. 定義輔助函式
            function getCurrentFilterValue() {
                const selectedRadio = document.querySelector('input[name="orderStatusFilter"]:checked');
                return selectedRadio ? selectedRadio.value : 'active'; // 預設篩選 'active'
            }

            function fetchWithCurrentFilters(dateParams) {
                const filterStatus = getCurrentFilterValue();
                // 將日期參數和篩選狀態合併到一個物件中傳遞給 fetchOrders
                fetchOrders({ ...dateParams, filterStatus: filterStatus }); // 確保 fetchOrders 能處理 filterStatus
            }

            // 5. 移除舊的事件監聽器和初始載入邏輯，只使用新的邏輯

            // 為 Tab 按鈕設定事件監聽器
            todayTab.addEventListener('click', function () {
                fetchWithCurrentFilters({ date: todayStr });
            });

            tomorrowTab.addEventListener('click', function () {
                fetchWithCurrentFilters({ date: tomorrowStr });
            });

            customRangeTab.addEventListener('click', function () {
                // 點擊「自訂日期區間」Tab 時，不清空結果，也不主動查詢
                // 而是等待用戶在該 Tab 內操作日期選擇並點擊「查詢」按鈕
                // 也可以選擇在這裡清空結果區域或顯示提示
                // orderResultsBody.innerHTML = `<tr><td colspan="13" class="text-center">請選擇日期並點擊查詢。</td></tr>`;
            });

            searchCustomRangeBtn.addEventListener('click', function () {
                if (!startDateInput.value || !endDateInput.value) {
                    alert("請選擇開始和結束日期！");
                    return;
                }
                if (new Date(startDateInput.value) > new Date(endDateInput.value)) {
                    alert("開始日期不能晚於結束日期！");
                    return;
                }
                fetchWithCurrentFilters({ startDate: startDateInput.value, endDate: endDateInput.value });
            });

            // 為篩選器 radio buttons 加上事件監聽器
            filterRadios.forEach(radio => {
                radio.addEventListener('change', function () {
                    // 當篩選器改變時，重新觸發當前激活的 Tab 的查詢邏輯
                    const activeTabButton = document.querySelector('#queryOrderTabs .nav-link.active');
                    if (activeTabButton) {
                        if (activeTabButton.id === 'today-orders-tab') {
                            fetchWithCurrentFilters({ date: todayStr });
                        } else if (activeTabButton.id === 'tomorrow-orders-tab') {
                            fetchWithCurrentFilters({ date: tomorrowStr });
                        } else if (activeTabButton.id === 'custom-range-tab') {
                            // 如果自訂日期區間是激活的，且日期已填，則重新查詢
                            // 否則，用戶需要手動點擊 "查詢" 按鈕
                            if (startDateInput.value && endDateInput.value) {
                                if (new Date(startDateInput.value) > new Date(endDateInput.value)) {
                                    // 這裡可以選擇不 alert，讓查詢按鈕的驗證處理
                                    return;
                                }
                                fetchWithCurrentFilters({ startDate: startDateInput.value, endDate: endDateInput.value });
                            } else {
                                // 如果日期未填，可以清空結果或提示用戶點擊查詢按鈕
                                orderResultsBody.innerHTML = `<tr><td colspan="${document.querySelector('#orderResultsTableContainer thead tr')?.cells.length || 13}" class="text-center">請選擇日期並點擊查詢。</td></tr>`;
                            }
                        }
                    }
                });
            });

            // 6. 初始載入時，根據預選的 Tab 和篩選器載入資料
            const activeTabOnInit = document.querySelector('#queryOrderTabs .nav-link.active');
            if (activeTabOnInit) {
                if (activeTabOnInit.id === 'today-orders-tab') {
                    fetchWithCurrentFilters({ date: todayStr });
                } else if (activeTabOnInit.id === 'tomorrow-orders-tab') {
                    fetchWithCurrentFilters({ date: tomorrowStr });
                } else if (activeTabOnInit.id === 'custom-range-tab') {
                    // 自訂日期區間 Tab 初始激活時，通常不自動查詢，等待用戶操作
                    // 您也可以選擇在這裡根據預設日期查詢，如果這是期望的行為
                    orderResultsBody.innerHTML = `<tr><td colspan="${document.querySelector('#orderResultsTableContainer thead tr')?.cells.length || 13}" class="text-center">請選擇日期並點擊查詢。</td></tr>`;
                }
            } else {
                // 如果沒有預設激活的 Tab (理論上 Bootstrap 會預設第一個為 active)
                // 則預設載入今日訂單
                if (todayTab) fetchWithCurrentFilters({ date: todayStr });
            }
            console.log("查詢訂單檢視已正確初始化。");
        }



        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', function () {
            const navLinks = document.querySelectorAll('#sidebar .nav-link');
            const contentDisplay = document.getElementById('content-display'); // contentDisplay 在這裡定義
            const pageTitles = {
                '#dashboard': '儀表板', '#addOrder': '新增訂單', '#queryOrder': '查詢訂單',
                '#addDriver': '新增司機', '#queryDriver': '查詢司機'
            };

            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    navLinks.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    const targetId = this.getAttribute('href');
                    const title = pageTitles[targetId] || "頁面內容";
                    let currentContentHtml = '';

                    switch (targetId) {
                        case '#dashboard':
                            currentContentHtml = `<h4>${title}</h4><p>這裡是店家儀表板的內容。</p><p>您可以顯示今日訂單概況、待處理事項、司機出勤狀態等資訊。</p>`;
                            contentDisplay.innerHTML = currentContentHtml;
                            break;
                        case '#addOrder':
                            currentContentHtml = `<h2>${title}</h2><div class="form-container">` + // (加入表單HTML...)
                                `<div class="form-group"><label for="customerName">顧客姓名：</label><input type="text" id="customerName" name="customerName" required></div>` +
                                `<div class="form-group"><label for="customerPhone">顧客電話：</label><input type="tel" id="customerPhone" name="customerPhone" pattern="[0-9]{10}" placeholder="例如: 0912345678" required></div>` +
                                `<div class="form-group"><label for="customerAddress">顧客地址：</label><input type="text" id="customerAddress" name="customerAddress" required></div>` +
                                `<div class="form-group"><label for="airport">機場：</label><select id="airport" name="airport" required><option value="">請選擇機場...</option></select></div>` +
                                `<div class="form-group"><label for="terminal">航廈：</label><select id="terminal" name="terminal" required><option value="">請選擇航廈...</option></select></div>` +
                                `<div class="form-group"><label for="serviceType">服務類型：</label><select id="serviceType" name="serviceType" required><option value="">請選擇服務類型...</option><option value="接機">接機</option><option value="送機">送機</option></select></div>` +
                                `<div class="form-group"><label for="scheduledPickupTime">預定用車時間：</label><input type="datetime-local" id="scheduledPickupTime" name="scheduledPickupTime" required></div>` +
                                `<div class="form-group"><label for="carType">車輛類型：</label><select id="carType" name="carType" required><option value="">請選擇車輛...</option></select></div>` +
                                `<div class="form-group"><label>加購項目：</label><div id="addonsContainer"><p>正在載入加購項目...</p></div></div>` +
                                `<div class="form-group"><label for="totalAmount">訂單總金額：</label><input type="number" id="totalAmount" name="totalAmount" step="0.01" min="1" required placeholder="請手動輸入總金額"></div>` +
                                `<button type="button" onclick="submitOrder()">新增訂單</button><div id="submissionStatus" style="margin-top: 15px;"></div></div>`;
                            contentDisplay.innerHTML = currentContentHtml;
                            initializeAddOrderForm();
                            break;
                        case '#queryOrder':
                            currentContentHtml = `<h4>${title}</h4>` +
                                // --- 新增的篩選器 ---
                                `<div class="row mb-3 align-items-center">
                                   <div class="col-auto">
            <label class="form-label mb-0">篩選訂單：</label>
        </div>
        <div class="col-auto">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="orderStatusFilter" id="filterActiveOrders" value="active" checked>
                <label class="form-check-label" for="filterActiveOrders">顯示有效訂單</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="orderStatusFilter" id="filterAllOrders" value="all">
                <label class="form-check-label" for="filterAllOrders">顯示所有訂單(含取消)</label>
            </div>
        </div>
    </div>` +
                                // --- 篩選器結束 ---
                                `<p>請選擇查詢條件：</p>` + // 您原有的文字
                                `<ul class="nav nav-tabs mb-3" id="queryOrderTabs" role="tablist"><li class="nav-item" role="presentation"><button class="nav-link active" id="today-orders-tab" data-bs-toggle="tab" data-bs-target="#today-orders-pane" type="button" role="tab" aria-controls="today-orders-pane" aria-selected="true">今日訂單</button></li><li class="nav-item" role="presentation"><button class="nav-link" id="tomorrow-orders-tab" data-bs-toggle="tab" data-bs-target="#tomorrow-orders-pane" type="button" role="tab" aria-controls="tomorrow-orders-pane" aria-selected="false">明日訂單</button></li><li class="nav-item" role="presentation"><button class="nav-link" id="custom-range-tab" data-bs-toggle="tab" data-bs-target="#custom-range-pane" type="button" role="tab" aria-controls="custom-range-pane" aria-selected="false">自訂日期區間</button></li></ul>` +
                                `<div class="tab-content" id="queryOrderTabContent"><div class="tab-pane fade show active" id="today-orders-pane" role="tabpanel" aria-labelledby="today-orders-tab" tabindex="0"></div><div class="tab-pane fade" id="tomorrow-orders-pane" role="tabpanel" aria-labelledby="tomorrow-orders-tab" tabindex="0"></div><div class="tab-pane fade" id="custom-range-pane" role="tabpanel" aria-labelledby="custom-range-tab" tabindex="0"><div class="row g-3 align-items-center mb-3"><div class="col-auto"><label for="startDate" class="col-form-label">開始日期:</label></div><div class="col-auto"><input type="date" id="startDate" class="form-control"></div><div class="col-auto"><label for="endDate" class="col-form-label">結束日期:</label></div><div class="col-auto"><input type="date" id="endDate" class="form-control"></div><div class="col-auto"><button class="btn btn-primary" id="searchCustomRange">查詢</button></div></div><div id="customRangeResults"><p>請選擇日期並點擊查詢。</p></div></div></div>` +
                                `<div class="mt-3"><h5>查詢結果:</h5><div id="orderResultsTableContainer" class="table-responsive"><table class="table table-striped table-hover table-sm"><thead><tr><th>訂單ID</th><th>顧客姓名</th><th>電話</th><th>地址</th><th>服務</th><th>預定時間</th><th>機場</th><th>航廈</th><th>車型</th><th>金額</th><th>訂單狀態</th><th>司機狀態</th><th>操作</th></tr></thead><tbody id="orderResultsBody"><tr><td colspan="13" class="text-center">請先選擇查詢條件以載入訂單。</td></tr></tbody></table><div id="loadingMessage" class="text-center" style="display: none;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p>載入中...</p></div><div id="noResultsMessage" class="alert alert-info" style="display: none;">找不到符合條件的訂單。</div></div></div>`;
                            contentDisplay.innerHTML = currentContentHtml;
                            initializeQueryOrderView();
                            break;
                        case '#addDriver':
                            currentContentHtml = `<h4>${title}</h4><p>請填寫新司機的資料：</p><div class="form-container"><div class="mb-3"><label for="driverNameInput" class="form-label">司機姓名：</label><input type="text" class="form-control" id="driverNameInput" required></div><div class="mb-3"><label for="driverPhoneInput" class="form-label">電話：</label><input type="text" class="form-control" id="driverPhoneInput" required></div><div class="mb-3"><label for="driverLicensePlateInput" class="form-label">車牌號碼：</label><input type="text" class="form-control" id="driverLicensePlateInput"></div><div class="mb-3"><label for="driverVehicleBrandInput" class="form-label">車輛廠牌：</label><input type="text" class="form-control" id="driverVehicleBrandInput"></div><div class="mb-3"><label for="driverNotesInput" class="form-label">備註：</label><input type="text" class="form-control" id="driverNotesInput"></div><button type="button" class="btn btn-success" onclick="submitNewDriver()">新增司機</button><div id="addDriverStatus" class="mt-3"></div></div>`;
                            contentDisplay.innerHTML = currentContentHtml;
                            break;
                        case '#queryDriver':
                            currentContentHtml = `<h4>${title}</h4><p>所有司機列表：</p><div id="driverTableContainer" class="table-responsive"><table class="table table-striped table-hover"><thead><tr><th>司機ID</th><th>司機名字</th><th>電話</th><th>車牌號碼</th><th>車輛廠牌</th><th>備註</th><th>操作</th></tr></thead><tbody id="driverResultsBody"><tr><td colspan="7" class="text-center">正在載入司機資料...</td></tr></tbody></table><div id="driverLoadingMessage" class="text-center" style="display: none;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p>載入中...</p></div><div id="noDriverResultsMessage" class="alert alert-info" style="display: none;">目前沒有司機資料。</div></div></div>`;
                            contentDisplay.innerHTML = currentContentHtml;
                            initializeQueryDriverView();
                            break;
                        default:
                            currentContentHtml = `<h4>頁面載入錯誤</h4><p>找不到對應的內容。</p>`;
                            contentDisplay.innerHTML = currentContentHtml;
                    }
                });
            });

            if (document.querySelector('#sidebar .nav-item .active')) {
                document.querySelector('#sidebar .nav-item .active').click();
            }
        });
    </script>
</body>

</html>